name: Check Generated Files

on:
  pull_request:
    branches:
      - main
    paths:
      - 'config/**'
      - 'dist/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  check-generated-files:
    name: Verify No Manual Changes to Generated Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for config/ or dist/ changes
        run: |
          echo "❌ ERROR: Manual changes detected in generated directories"
          echo ""
          echo "The following directories are managed by kubebuilder and should NOT be modified manually:"
          echo "  • config/  - Generated by 'make manifests'"
          echo "  • dist/    - Generated by 'make build-installer'"
          echo ""
          echo "Changed files:"
          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^(config|dist)/' || true
          echo ""
          echo "To update these files correctly:"
          echo "  1. Modify the source files (api/, internal/controller/, etc.)"
          echo "  2. Run 'make manifests' to regenerate config/"
          echo "  3. Run 'make build-installer' to regenerate dist/"
          echo "  4. Commit the source changes only (config/ and dist/ are generated during release)"
          echo ""
          exit 1

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ⚠️ Generated Files Modified
            
            This PR includes manual changes to generated directories:
            - \`config/\` - Managed by \`make manifests\`
            - \`dist/\` - Managed by \`make build-installer\`
            
            ### Why is this blocked?
            
            These directories contain files generated by kubebuilder and should not be modified manually. Manual changes will be overwritten during the release process.
            
            ### How to fix:
            
            1. **Revert the changes** to \`config/\` and/or \`dist/\`:
               \`\`\`bash
               git restore config/ dist/
               \`\`\`
            
            2. **Modify the source files** instead:
               - For CRD changes: Edit \`api/v1/nebariapp_types.go\`
               - For RBAC/deployment changes: These are controlled by kubebuilder markers
            
            3. **Regenerate locally** (optional, for testing):
               \`\`\`bash
               make manifests
               make build-installer
               \`\`\`
            
            4. **Commit only source changes**:
               \`\`\`bash
               git add api/ internal/ cmd/
               git commit -m "your changes"
               \`\`\`
            
            The \`config/\` and \`dist/\` directories will be automatically regenerated during the release workflow.
            
            ---
            
            **Note:** If you're a maintainer updating these files intentionally (e.g., during release), you can override this check by adding \`[skip generated-check]\` to your commit message.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
