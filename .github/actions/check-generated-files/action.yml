name: 'Check Generated Files'
description: 'Validates that config/ and dist/ directories are not manually modified'
inputs:
  github-token:
    description: 'GitHub token for posting comments'
    required: true
  base-ref:
    description: 'Base branch reference'
    required: true
    default: 'main'

runs:
  using: 'composite'
  steps:
    - name: Check for skip marker in commit messages
      id: check-skip
      shell: bash
      run: |
        # Check if any commit in this PR has [skip generated-check]
        COMMITS=$(git log origin/${{ inputs.base-ref }}..HEAD --pretty=format:"%s")
        if echo "$COMMITS" | grep -qi '\[skip generated-check\]'; then
          echo "skip=true" >> $GITHUB_OUTPUT
          echo "✅ Found [skip generated-check] in commit message - skipping validation"
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Get changed files
      id: changed-files
      if: steps.check-skip.outputs.skip != 'true'
      shell: bash
      run: |
        CHANGED_FILES=$(git diff --name-only origin/${{ inputs.base-ref }}...HEAD | grep -E '^(config|dist)/' || echo "")
        if [ -n "$CHANGED_FILES" ]; then
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "has-changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Fail if generated files were modified
      if: steps.check-skip.outputs.skip != 'true' && steps.changed-files.outputs.has-changes == 'true'
      shell: bash
      run: |
        echo "❌ ERROR: Manual changes detected in generated directories"
        echo ""
        echo "The following directories are managed by kubebuilder and should NOT be modified manually:"
        echo "  • config/  - Generated by 'make manifests'"
        echo "  • dist/    - Generated by 'make build-installer'"
        echo ""
        echo "Changed files:"
        echo "${{ steps.changed-files.outputs.files }}"
        echo ""
        echo "To update these files correctly:"
        echo "  1. Modify the source files (api/, internal/controller/, etc.)"
        echo "  2. Run 'make manifests' to regenerate config/"
        echo "  3. Run 'make build-installer' to regenerate dist/"
        echo "  4. Commit the source changes only (config/ and dist/ are generated during release)"
        echo ""
        echo "To skip this check (maintainers only): Add [skip generated-check] to your commit message"
        echo ""
        exit 1

    - name: Comment on PR
      if: always() && steps.check-skip.outputs.skip != 'true' && steps.changed-files.outputs.has-changes == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const changedFiles = `${{ steps.changed-files.outputs.files }}`;
          const fileList = changedFiles.split('\n').filter(f => f.trim()).map(f => `- \`${f}\``).join('\n');

          const body = `## ⚠️ Generated Files Modified

          This PR includes manual changes to generated directories that should not be modified directly:

          ${fileList}

          ### Why is this blocked?

          The \`config/\` and \`dist/\` directories contain files generated by kubebuilder/make and should not be modified manually. Manual changes will be overwritten during the release process.

          ### How to fix:

          1. **Revert the changes** to generated files:
             \`\`\`bash
             git restore config/ dist/
             \`\`\`

          2. **Modify the source files** instead:
             - For CRD changes: Edit \`api/v1/nebariapp_types.go\`
             - For RBAC/deployment changes: Controlled by kubebuilder markers in code
             - For config changes: Edit source manifests in \`config/\` subdirectories (if needed)

          3. **Regenerate locally** (optional, for testing):
             \`\`\`bash
             make manifests        # Regenerate CRDs and RBAC
             make build-installer  # Regenerate dist/install.yaml
             \`\`\`

          4. **Commit only source changes**:
             \`\`\`bash
             git add api/ internal/ cmd/
             git commit -m "your changes"
             \`\`\`

          > **Note:** The \`config/\` and \`dist/\` directories will be automatically regenerated during the release workflow.

          ### For Maintainers

          If you're intentionally updating generated files (e.g., fixing CRD issues, release maintenance), add \`[skip generated-check]\` to your commit message to bypass this validation.`;

          // Check if we already commented
          const {data: comments} = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });

          const existingComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('⚠️ Generated Files Modified')
          );

          if (existingComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              comment_id: existingComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          }
