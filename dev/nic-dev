#!/usr/bin/env bash

# NIC Operator Development Tool
# Unified script for managing local development environment

set -euo pipefail

# Resolve the actual script location (follow symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

CLUSTER_NAME="${CLUSTER_NAME:-nic-operator-dev}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_usage() {
    cat <<EOF
NIC Operator Development Tool

Usage: $0 <command> [options]

Commands:
  setup              Set up complete local development environment
                     (creates cluster + installs services)

  cluster:create     Create KIND cluster
  cluster:delete     Delete KIND cluster
  cluster:info       Show cluster information

  services:install   Install foundational services (Envoy, cert-manager, Keycloak)
  services:status    Check status of foundational services

  gateway:ip         Get the LoadBalancer IP for the public gateway
  gateway:setup      Setup traffic forwarding for LoadBalancer access (macOS)
  gateway:forward    Port forward gateway via kubectl (alternative method)

  operator:deploy    Build and deploy the operator
  operator:logs      Show operator logs
  operator:delete    Delete the operator

  samples:deploy     Deploy sample applications
  samples:deploy-auth Deploy sample with authentication enabled
  samples:delete     Delete sample applications

  verify             Run comprehensive setup verification
  clean              Delete everything (cluster + all resources)

  help               Show this help message

Environment Variables:
  CLUSTER_NAME       Name of the KIND cluster (default: nic-operator-dev)

Examples:
  $0 setup                    # Full setup from scratch
  $0 cluster:create           # Just create the cluster
  $0 services:install         # Install foundational services
  $0 operator:deploy          # Deploy the operator
  $0 verify                   # Verify everything is working
  $0 clean                    # Clean up everything

EOF
}

log_info() {
    echo -e "${BLUE}â„¹${NC}  $*"
}

log_success() {
    echo -e "${GREEN}âœ“${NC}  $*"
}

log_warning() {
    echo -e "${YELLOW}âš ${NC}  $*"
}

log_error() {
    echo -e "${RED}âœ—${NC}  $*"
}

cmd_setup() {
    log_info "Setting up complete local development environment"
    echo ""
    cmd_cluster_create
    echo ""
    cmd_services_install
    echo ""
    log_success "Setup complete! ðŸŽ‰"
    echo ""
    if [[ "$OSTYPE" == "darwin"* ]]; then
        log_info "Gateway access has been configured for macOS"
    fi
    echo ""
    log_info "Next steps:"
    echo "  1. Deploy operator: $0 operator:deploy"
    echo "  2. Deploy samples: $0 samples:deploy"
    echo "  3. Verify setup: $0 verify"
}

cmd_cluster_create() {
    log_info "Creating KIND cluster: ${CLUSTER_NAME}"

    if kind get clusters | grep -q "^${CLUSTER_NAME}$"; then
        log_warning "Cluster '${CLUSTER_NAME}' already exists"
        read -p "Delete and recreate? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            cmd_cluster_delete
        else
            log_success "Using existing cluster"
            return 0
        fi
    fi

    log_info "Creating cluster with configuration"
    kind create cluster --config="${SCRIPT_DIR}/local-cluster/kind-config.yaml"

    log_info "Waiting for cluster to be ready..."
    kubectl wait --for=condition=Ready nodes --all --timeout=300s

    log_success "KIND cluster '${CLUSTER_NAME}' is ready!"

    log_info "Setting up MetalLB for LoadBalancer support..."
    cd "${SCRIPT_DIR}"
    ./local-cluster/setup-metallb.sh

    cmd_cluster_info
}

cmd_cluster_delete() {
    log_info "Deleting KIND cluster: ${CLUSTER_NAME}"

    if ! kind get clusters | grep -q "^${CLUSTER_NAME}$"; then
        log_warning "Cluster '${CLUSTER_NAME}' does not exist"
        return 0
    fi

    kind delete cluster --name "${CLUSTER_NAME}"
    log_success "Cluster '${CLUSTER_NAME}' deleted"
}

cmd_cluster_info() {
    if ! kind get clusters | grep -q "^${CLUSTER_NAME}$"; then
        log_error "Cluster '${CLUSTER_NAME}' does not exist"
        return 1
    fi

    echo ""
    echo "ðŸ“‹ Cluster Info:"
    kubectl cluster-info --context "kind-${CLUSTER_NAME}"
    echo ""
    echo "ðŸ” Nodes:"
    kubectl get nodes
}

cmd_services_install() {
    log_info "Installing foundational services"
    cd "${SCRIPT_DIR}"
    ./local-cluster/setup-foundational-services.sh

    # Setup gateway forwarding on macOS
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo ""
        log_info "Setting up gateway access for macOS..."
        ./local-cluster/setup-gateway-forward.sh
    fi
}

cmd_services_status() {
    log_info "Checking foundational services status"
    echo ""

    echo "Gateway API & Envoy Gateway:"
    kubectl get pods -n envoy-gateway-system 2>/dev/null || log_warning "Not installed"
    echo ""

    echo "cert-manager:"
    kubectl get pods -n cert-manager 2>/dev/null || log_warning "Not installed"
    echo ""

    echo "Keycloak:"
    kubectl get pods -n keycloak 2>/dev/null || log_warning "Not installed"
    echo ""

    echo "Gateways:"
    kubectl get gateway -n envoy-gateway-system 2>/dev/null || log_warning "Not configured"
}

cmd_gateway_ip() {
    log_info "Getting LoadBalancer IP for public gateway"
    GATEWAY_IP=$(kubectl get svc -n envoy-gateway-system \
      -l gateway.envoyproxy.io/owning-gateway-name=nic-public-gateway \
      -o jsonpath='{.items[0].status.loadBalancer.ingress[0].ip}' 2>/dev/null)

    if [ -z "$GATEWAY_IP" ]; then
        log_error "Could not get gateway IP. Is MetalLB configured?"
        return 1
    fi

    echo ""
    echo "ðŸ“ Public Gateway LoadBalancer IP: ${GATEWAY_IP}"
    echo ""
    log_info "To access services, add to /etc/hosts:"
    echo "    ${GATEWAY_IP}  your-app.nic.local"
    echo ""
    log_warning "Note: On macOS, you may need docker-mac-net-connect to access this IP"
    log_info "See dev/MACOS_NETWORK_ACCESS.md for details"
}

cmd_gateway_forward() {
    log_info "Setting up port forwarding for gateway access"
    log_warning "This is a workaround for macOS Docker networking"
    echo ""

    SVC_NAME=$(kubectl get svc -n envoy-gateway-system \
      -l gateway.envoyproxy.io/owning-gateway-name=nic-public-gateway \
      -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)

    if [ -z "$SVC_NAME" ]; then
        log_error "Could not find gateway service"
        return 1
    fi

    log_info "Forwarding ${SVC_NAME} to localhost:8080"
    log_info "Access apps at: http://localhost:8080 (with Host header)"
    log_info "Or update /etc/hosts: 127.0.0.1 your-app.nic.local"
    echo ""
    log_warning "Press Ctrl+C to stop"
    echo ""

    kubectl port-forward -n envoy-gateway-system "svc/${SVC_NAME}" 8080:80
}

cmd_gateway_setup() {
    log_info "Setting up gateway access for macOS"
    cd "${SCRIPT_DIR}"
    ./local-cluster/setup-gateway-forward.sh
}

cmd_operator_deploy() {
    log_info "Building and deploying operator"

    cd "${SCRIPT_DIR}/.."

    log_info "Building operator image"
    make docker-build

    log_info "Loading image into KIND"
    make kind-load

    log_info "Deploying operator"
    kubectl apply -k config/default

    log_info "Waiting for operator to be ready"
    kubectl wait --for=condition=available --timeout=300s \
        deployment/nic-operator-controller-manager -n nic-operator-system 2>/dev/null || true

    log_success "Operator deployed!"
}

cmd_operator_logs() {
    kubectl logs -n nic-operator-system deployment/nic-operator-controller-manager -f
}

cmd_operator_delete() {
    log_info "Deleting operator"
    kubectl delete -k config/default --ignore-not-found=true
    log_success "Operator deleted"
}

cmd_samples_deploy() {
    log_info "Deploying sample applications"
    cd "${SCRIPT_DIR}"
    ./local-cluster/sample-apps/deploy-samples.sh
    echo ""
    if [[ "$OSTYPE" == "darwin"* ]]; then
        log_info "ðŸ’¡ Don't forget to run: ./dev/nic-dev gateway:setup (if not done yet)"
    fi
}

cmd_samples_deploy_auth() {
    log_info "Deploying sample application with authentication enabled"

    # Deploy the regular app first if not exists
    if ! kubectl get namespace demo-app >/dev/null 2>&1; then
        log_info "Deploying base application first..."
        cmd_samples_deploy
        echo ""
    fi

    log_info "Deploying authenticated sample: nginx-demo-auth"
    kubectl apply -f "${SCRIPT_DIR}/local-cluster/sample-apps/nginx-demo-with-auth.yaml"

    log_success "Authenticated sample deployed!"
    echo ""
    log_info "ðŸ“‹ Testing authentication:"
    echo ""
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "1. Setup gateway access (if not done yet):"
        echo "   ./dev/nic-dev gateway:setup"
        echo ""
        echo "2. Add to /etc/hosts:"
        echo "   echo '127.0.0.1  nginx-demo-auth.nic.local' | sudo tee -a /etc/hosts"
    else
        echo "1. Add to /etc/hosts:"
        echo "   echo '127.0.0.1  nginx-demo-auth.nic.local' | sudo tee -a /etc/hosts"
    fi
    echo ""
    echo "3. Access the application:"
    echo "   https://nginx-demo-auth.nic.local"
    echo "   (Should redirect to Keycloak login)"
    echo ""
    echo "4. Check NicApp status:"
    echo "   kubectl get nicapp -n demo-app nginx-demo-auth"
    echo "   kubectl describe nicapp -n demo-app nginx-demo-auth"
    echo ""
    log_info "See dev/local-cluster/sample-apps/AUTHENTICATION.md for details"
}

cmd_samples_delete() {
    log_info "Deleting sample applications"
    cd "${SCRIPT_DIR}"
    kubectl delete -f ./local-cluster/sample-apps/nginx-demo.yaml --ignore-not-found=true
    kubectl delete -f ./local-cluster/sample-apps/nginx-demo-nicapp.yaml --ignore-not-found=true
    kubectl delete -f ./local-cluster/sample-apps/nginx-demo-with-auth.yaml --ignore-not-found=true
    log_success "Sample applications deleted"
}

cmd_verify() {
    cd "${SCRIPT_DIR}"
    ./local-cluster/verify-setup.sh
}

cmd_clean() {
    log_warning "This will delete the entire development environment"
    read -p "Are you sure? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Cancelled"
        return 0
    fi

    log_info "Cleaning up development environment"
    cmd_cluster_delete
    log_success "Clean up complete"
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        print_usage
        exit 1
    fi

    case "$1" in
        setup)
            cmd_setup
            ;;
        cluster:create)
            cmd_cluster_create
            ;;
        cluster:delete)
            cmd_cluster_delete
            ;;
        cluster:info)
            cmd_cluster_info
            ;;
        services:install)
            cmd_services_install
            ;;
        services:status)
            cmd_services_status
            ;;
        gateway:ip)
            cmd_gateway_ip
            ;;
        gateway:setup)
            cmd_gateway_setup
            ;;
        gateway:forward)
            cmd_gateway_forward
            ;;
        operator:deploy)
            cmd_operator_deploy
            ;;
        operator:logs)
            cmd_operator_logs
            ;;
        operator:delete)
            cmd_operator_delete
            ;;
        samples:deploy)
            cmd_samples_deploy
            ;;
        samples:deploy-auth)
            cmd_samples_deploy_auth
            ;;
        samples:delete)
            cmd_samples_delete
            ;;
        verify|validate)
            cmd_verify
            ;;
        clean)
            cmd_clean
            ;;
        help|--help|-h)
            print_usage
            ;;
        *)
            log_error "Unknown command: $1"
            echo ""
            print_usage
            exit 1
            ;;
    esac
}

main "$@"
